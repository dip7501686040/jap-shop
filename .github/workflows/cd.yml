name: Kubernetes Deploy

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Docker CI"]
    types:
      - completed
    branches:
      - dev

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download affected apps artifact
        uses: actions/download-artifact@v4
        with:
          name: affectedapps
          path: ./artifact
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read and process affected apps
        run: |
          AFFECTED=$(cat ./artifact/affectedapps.txt)
          IFS=',' read -ra APPS <<< "$AFFECTED"
          for app in "${APPS[@]}"; do
            echo "Deploying $app"
            # Add your deployment logic here
          done

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          sparse-checkout: k8s
          sparse-checkout-cone-mode: false

      - name: Deploy affected apps to Kubernetes
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Reading affected apps from artifact..."
            cat ./artifact/affectedapps.txt
            AFFECTED=$(cat ./artifact/affectedapps.txt)
          else
            echo "Manual trigger: deploying all apps"
            AFFECTED=$(find k8s/* -type d -maxdepth 0 | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          echo "Deploying apps: $AFFECTED"
          AFFECTED=$(cat ./artifact/affectedapps.txt)
          IFS=',' read -ra APPS <<< "$AFFECTED"
          for app in "${APPS[@]}"; do
            echo "Deploying $app"
            kubectl apply -f k8s/$app
          done